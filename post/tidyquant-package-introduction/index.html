<!DOCTYPE html>
<html lang="en">
  <head>
    
    
      <title>
        Tidyquant套件介紹 ::
        Hello Friend, I&#39;m Yesting!
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="前言 R語言在財務領域中，常用到的套件大概有下列幾個：
 xts/zoo: 處理時間序列之套件。 TTR: 計算金融資產技術指標之套件。 quantmod: 金融資產技術分析回測套件，可至Yahoo Finance或Google Finance下載歷史股價數據或其他金融相關數據。並且整合TTR套件，繪製出漂亮的技術分析圖析。 PerformanceAnalytics: 計算金融資產報酬績效指標之套件。  現在的R語言在資料科學的浪潮之下，資料數據格式已走向tidy data形式。tidyverse套件已是每位R使用者必學的套件，使用此套件讓資料整理的程式碼簡潔又快速，讓R語言的方便性邁向更高一層。然而在財務領域的套件，目前皆是以時間序列資料格式(xts)為基礎建構而成。意即要使用這些套件的函數時，需要先將資料先轉為xts格式，才能做財務分析。若要在tidyverse套件中使用這些財務領域套件的函數，會有許多限制，需要做額外的整理才能使用，非常不方便。
針對這個痛點，R語言有人站出來解決這個問題，Matt Dancho和Davis Vaughan開發出tidyquant套件，為財務領域套件與tidyverse套件搭起一座橋梁，讓tidyverse套件能夠很輕易地使用財務領域套件。
tidyquant套件的作者Matt Dancho寫出許多詳盡的說明範例檔案，可參考以下連結:
 Introduction to tidyquant Core Functions in tidyquant R Quantitative Analysis Package Integrations in tidyquant Scaling and Modeling with tidyquant Charting with tidyquant Performance Analysis with tidyquant  當然，本篇文章的說明也都是從以上的說明範例檔案來學習並寫出來的！差別在於我們是用中文說明及臺灣的股市價格資料來做範例，並只擷取重要部分，讓大家可以快速地掌握脈絡。
 數據下載 做股市分析的第一步就是要取得股價資料，tidyquant套件的tq_get()函數整合quantmod套件的getSymbols()函數。透過tq_get()函數可以從網路上一次下載多檔股票資料，並且以tibble格式儲存資料，讓後續的資料處理更加方便。此處示範如何下載2017/06/01至2018/05/31，鴻海、台積電、中華電信及臺灣加權指數的歷史價格資料。在tq_get()函數內的引數為:
 x: 金融資產的代碼，需配合資料源。 get: 資料下載來源，此處我們設定參數為stock.price，從Yahoo Finance下載歷史股價資料。 from: 資料下載起始日。 to: 資料下載結束日。  tq_get()函數可下載的資料來源相當多，除了股價資料外，也有財務比率指標(Morningstar)、股利股息資料(Yahoo Finance)及總經資料(FRED)等，只要修改函數內的get參數即可取得。詳細內容可參考原作者的說明文件：Core Functions in tidyquant。"
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/post/tidyquant-package-introduction/" />


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'G-L50G2LV7Q6', 'auto');
	
	ga('send', 'pageview');
}
</script>






<link rel="stylesheet" href="/assets/style.css" />

<link rel="stylesheet" href="/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Tidyquant套件介紹"/>
<meta name="twitter:description" content="此篇文章主要介紹R的`tidyquant`套件，此文章同時發表於[中山管院:商業大數據平台](https://bap.cm.nsysu.edu.tw/?page_id=1046)。"/>



<meta property="og:title" content="Tidyquant套件介紹" />
<meta property="og:description" content="此篇文章主要介紹R的`tidyquant`套件，此文章同時發表於[中山管院:商業大數據平台](https://bap.cm.nsysu.edu.tw/?page_id=1046)。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/tidyquant-package-introduction/" />
<meta property="article:published_time" content="2018-06-10T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-06-10T00:00:00+00:00" /><meta property="og:site_name" content="Hello Friend, I&#39;m Yesting!" />







    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-L50G2LV7Q6"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-L50G2LV7Q6');
    </script>

  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Hello Friend, I&#39;m Yestin!</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
      
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Tidyquant套件介紹</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2018-06-10
        </span>

        
          
        
      

      
        <span class="post-author"
          >— Written by Yen-Ting, Su</span
        >


      
    </div>

    
      <span class="post-tags">
        
          <a href="/tags/r/">#R</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <hr>
<h2 id="前言">前言</h2>
<p>R語言在財務領域中，常用到的套件大概有下列幾個：</p>
<ul>
<li><a href="https://cran.r-project.org/web/packages/xts/xts.pdf">xts</a>/<a href="https://cran.r-project.org/web/packages/zoo/zoo.pdf">zoo</a>: 處理時間序列之套件。</li>
<li><a href="https://cran.r-project.org/web/packages/TTR/TTR.pdf">TTR</a>: 計算金融資產技術指標之套件。</li>
<li><a href="https://cran.r-project.org/web/packages/quantmod/quantmod.pdf">quantmod</a>: 金融資產技術分析回測套件，可至<a href="https://finance.yahoo.com/">Yahoo Finance</a>或<a href="https://finance.google.com/">Google Finance</a>下載歷史股價數據或其他金融相關數據。並且整合<code>TTR</code>套件，繪製出漂亮的技術分析圖析。</li>
<li><a href="https://cran.r-project.org/web/packages/PerformanceAnalytics/PerformanceAnalytics.pdf">PerformanceAnalytics</a>: 計算金融資產報酬績效指標之套件。</li>
</ul>
<p>現在的R語言在資料科學的浪潮之下，資料數據格式已走向<a href="https://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html">tidy data</a>形式。<a href="https://www.tidyverse.org/">tidyverse</a>套件已是每位R使用者必學的套件，使用此套件讓資料整理的程式碼簡潔又快速，讓R語言的方便性邁向更高一層。然而在財務領域的套件，目前皆是以時間序列資料格式(xts)為基礎建構而成。意即要使用這些套件的函數時，需要先將資料先轉為xts格式，才能做財務分析。若要在<code>tidyverse</code>套件中使用這些財務領域套件的函數，會有許多限制，需要做額外的整理才能使用，非常不方便。</p>
<p>針對這個痛點，R語言有人站出來解決這個問題，Matt Dancho和Davis Vaughan開發出<a href="https://cran.r-project.org/web/packages/tidyquant/tidyquant.pdf">tidyquant</a>套件，為財務領域套件與<code>tidyverse</code>套件搭起一座橋梁，讓<code>tidyverse</code>套件能夠很輕易地使用財務領域套件。</p>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<p><code>tidyquant</code>套件的作者Matt Dancho寫出許多詳盡的說明範例檔案，可參考以下連結:</p>
<ul>
<li><a href="https://cran.r-project.org/web/packages/tidyquant/vignettes/TQ00-introduction-to-tidyquant.html">Introduction to tidyquant</a></li>
<li><a href="https://cran.r-project.org/web/packages/tidyquant/vignettes/TQ01-core-functions-in-tidyquant.html#get-quantitative-data">Core Functions in tidyquant</a></li>
<li><a href="https://cran.r-project.org/web/packages/tidyquant/vignettes/TQ02-quant-integrations-in-tidyquant.html">R Quantitative Analysis Package Integrations in tidyquant</a></li>
<li><a href="https://cran.r-project.org/web/packages/tidyquant/vignettes/TQ03-scaling-and-modeling-with-tidyquant.html">Scaling and Modeling with tidyquant</a></li>
<li><a href="https://cran.r-project.org/web/packages/tidyquant/vignettes/TQ04-charting-with-tidyquant.html">Charting with tidyquant</a></li>
<li><a href="https://cran.r-project.org/web/packages/tidyquant/vignettes/TQ05-performance-analysis-with-tidyquant.html">Performance Analysis with tidyquant</a></li>
</ul>
<p>當然，本篇文章的說明也都是從以上的說明範例檔案來學習並寫出來的！差別在於我們是用中文說明及臺灣的股市價格資料來做範例，並只擷取重要部分，讓大家可以快速地掌握脈絡。</p>
<hr>
<h2 id="數據下載">數據下載</h2>
<p>做股市分析的第一步就是要取得股價資料，<code>tidyquant</code>套件的<code>tq_get()</code>函數整合<code>quantmod</code>套件的<code>getSymbols()</code>函數。透過<code>tq_get()</code>函數可以從網路上一次下載多檔股票資料，並且以<code>tibble</code>格式儲存資料，讓後續的資料處理更加方便。此處示範如何下載2017/06/01至2018/05/31，鴻海、台積電、中華電信及臺灣加權指數的歷史價格資料。在<code>tq_get()</code>函數內的引數為:</p>
<ol>
<li>x: 金融資產的代碼，需配合資料源。</li>
<li>get: 資料下載來源，此處我們設定參數為<code>stock.price</code>，從<a href="https://finance.yahoo.com/">Yahoo Finance</a>下載歷史股價資料。</li>
<li>from: 資料下載起始日。</li>
<li>to: 資料下載結束日。</li>
</ol>
<p><code>tq_get()</code>函數可下載的資料來源相當多，除了股價資料外，也有財務比率指標(<a href="https://www.morningstar.com/">Morningstar</a>)、股利股息資料(<a href="https://finance.yahoo.com/">Yahoo Finance</a>)及總經資料(<a href="https://fred.stlouisfed.org/">FRED</a>)等，只要修改函數內的<code>get</code>參數即可取得。詳細內容可參考原作者的說明文件：<a href="https://cran.r-project.org/web/packages/tidyquant/vignettes/TQ01-core-functions-in-tidyquant.html#get-quantitative-data">Core Functions in tidyquant</a>。</p>
<p>我們在<a href="https://finance.yahoo.com/">Yahoo Finance</a>要下載的股票代碼為：鴻海(2317.TW)、台積電(2330.TW)及中華電信(2412.TW)及臺灣加權指數(^TWII)，程式碼寫法如下:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># 載入套件</span>
<span style="color:#a6e22e">library</span>(tidyquant)

<span style="color:#75715e"># 下載資料</span>
stockData <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;^TWII&#34;</span>, <span style="color:#e6db74">&#34;2317.TW&#34;</span>, <span style="color:#e6db74">&#34;2330.TW&#34;</span>, <span style="color:#e6db74">&#34;2412.TW&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">tq_get</span>(get <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;stock.price&#34;</span>, from <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2017-06-01&#34;</span>, to <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2018-05-31&#34;</span>)

<span style="color:#75715e"># 觀看資料</span>
stockData
</code></pre></div><pre><code>## # A tibble: 988 x 8
##    symbol       date     open     high      low    close  volume adjusted
##     &lt;chr&gt;     &lt;date&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
##  1  ^TWII 2017-06-01 10064.44 10100.37 10059.93 10087.42 1923600 10087.42
##  2  ^TWII 2017-06-02 10117.76 10152.53 10117.06 10152.53 2037600 10152.53
##  3  ^TWII 2017-06-03       NA       NA       NA       NA      NA       NA
##  4  ^TWII 2017-06-05 10164.89 10226.84 10164.89 10226.84 2141900 10226.84
##  5  ^TWII 2017-06-06 10213.17 10221.64 10190.39 10206.18 2016200 10206.18
##  6  ^TWII 2017-06-07 10216.14 10242.39 10183.15 10209.99 2172700 10209.99
##  7  ^TWII 2017-06-08 10215.93 10235.70 10211.00 10225.78 1703500 10225.78
##  8  ^TWII 2017-06-09 10238.55 10268.37 10198.80 10199.65 2139100 10199.65
##  9  ^TWII 2017-06-12 10137.04 10158.64 10109.96 10109.96 1746300 10109.96
## 10  ^TWII 2017-06-13 10109.70 10146.67 10109.70 10128.15 1586300 10128.15
## # ... with 978 more rows
</code></pre><p>簡單的兩行程式碼就可以下載多檔股票歷史數據，並整理成tibble資料格式，與<code>quantmod</code>套件的<code>getSymbols()</code>函數相比真的是方便很多。然而有一個問題是，<a href="https://finance.yahoo.com/">Yahoo Finance</a>在台灣股市的資料維護其實並不太好。從上面下載的股價資料中，可以發現2017-06-03是以缺值資料紀錄，當日台股為端午節連假周六補交易日，<a href="https://finance.yahoo.com/">Yahoo Finance</a>的資料庫卻沒有記錄到，這明顯是有問題的。所以我們在做台灣股市的量化資料分析時，並不會直接從網路上下載資料，會直接從財務資料庫來取得資料，確保資料品質。下一小節將說明如何讀入外部資料，並整理成<code>tidyquant</code>套件能使用的格式。</p>
<hr>
<h2 id="範例資料來源">範例資料來源</h2>
<p>除了透過<code>tq_get()</code>函數自<a href="https://finance.yahoo.com/">Yahoo Finance</a>下載資料外，也可以從外部資料庫讀入數據，整理成<code>tidyquant</code>所需要的資料格式。此處以臺灣大專院校財金系最常使用的台灣經濟新報資料庫(TEJ)為例，透過特殊轉檔功能自TEJ下載資料輸出成txt檔案，然後再用R軟體讀入數據。資料期間為2017/06/01至2018/05/31之日頻調整後股價資料。分析資產標的分別為鴻海、台積電、中華電信股票及臺灣加權指數。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># 讀取數據</span>
stockData <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">read.table</span>(<span style="color:#e6db74">&#34;tej_data.txt&#34;</span>, header <span style="color:#f92672">=</span> T, sep <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;\t&#34;</span>, stringsAsFactors <span style="color:#f92672">=</span> F) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">as_data_frame</span>()

<span style="color:#75715e"># 整理資料欄位(依序為股票代碼、名稱、日期、開盤價、最高價、最低價、收盤價、成交量及成交金額)</span>
<span style="color:#a6e22e">colnames</span>(stockData) <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;code&#34;</span>, <span style="color:#e6db74">&#34;name&#34;</span>, <span style="color:#e6db74">&#34;date&#34;</span>, <span style="color:#e6db74">&#34;open&#34;</span>, <span style="color:#e6db74">&#34;high&#34;</span>, <span style="color:#e6db74">&#34;low&#34;</span>, <span style="color:#e6db74">&#34;close&#34;</span>, <span style="color:#e6db74">&#34;volume&#34;</span>, <span style="color:#e6db74">&#34;tradeValue&#34;</span>)

<span style="color:#75715e"># 將股票代碼及名稱空白格刪除</span>
stockData <span style="color:#f92672">&lt;-</span> stockData <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">mutate</span>(code <span style="color:#f92672">=</span> <span style="color:#a6e22e">gsub</span>(<span style="color:#e6db74">&#34;\\s+&#34;</span>,<span style="color:#e6db74">&#34;&#34;</span>, code),
         name <span style="color:#f92672">=</span> <span style="color:#a6e22e">gsub</span>(<span style="color:#e6db74">&#34;\\s+&#34;</span>,<span style="color:#e6db74">&#34;&#34;</span>, name))

<span style="color:#75715e"># 觀看資料</span>
stockData
</code></pre></div><pre><code>## # A tibble: 996 x 9
##     code     name     date     open     high      low    close  volume
##    &lt;chr&gt;    &lt;chr&gt;    &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;   &lt;int&gt;
##  1  2317     鴻海 20170601    99.57   100.53    99.09   100.53   27441
##  2  2330   台積電 20170601   198.39   200.32   197.90   200.32   29623
##  3  2412   中華電 20170601   103.13   103.60   102.65   103.13   10351
##  4 Y9999 加權指數 20170601 10064.44 10100.37 10059.93 10087.42 3935374
##  5  2317     鴻海 20170602   101.01   101.49   100.53   101.49   38194
##  6  2330   台積電 20170602   201.77   202.26   200.81   202.26   23265
##  7  2412   中華電 20170602   103.13   103.60   102.17   103.13    7341
##  8 Y9999 加權指數 20170602 10117.76 10152.53 10117.06 10152.53 4262071
##  9  2317     鴻海 20170603   101.01   101.49   100.53   101.01    9968
## 10  2330   台積電 20170603   202.26   202.26   201.29   202.26    1535
## # ... with 986 more rows, and 1 more variables: tradeValue &lt;int&gt;
</code></pre><p>由於TEJ資料庫我們採用特殊轉檔功能輸出，因此日期是以8碼數字格式儲存。為了讓<code>tidyquant</code>套件能夠運作，需將日期欄位由數字格式轉為日期格式。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># 將8碼數字日期格式轉為日期格式</span>
DateConvert <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(date){
  date <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">as.Date</span>(<span style="color:#a6e22e">as.character</span>(date), <span style="color:#e6db74">&#34;%Y%m%d&#34;</span>)
  <span style="color:#a6e22e">return</span>(date)
}

stockData <span style="color:#f92672">&lt;-</span> stockData <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">mutate</span>(date <span style="color:#f92672">=</span> <span style="color:#a6e22e">DateConvert</span>(date))

<span style="color:#75715e"># 觀看資料</span>
stockData
</code></pre></div><pre><code>## # A tibble: 996 x 9
##     code     name       date     open     high      low    close  volume
##    &lt;chr&gt;    &lt;chr&gt;     &lt;date&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;   &lt;int&gt;
##  1  2317     鴻海 2017-06-01    99.57   100.53    99.09   100.53   27441
##  2  2330   台積電 2017-06-01   198.39   200.32   197.90   200.32   29623
##  3  2412   中華電 2017-06-01   103.13   103.60   102.65   103.13   10351
##  4 Y9999 加權指數 2017-06-01 10064.44 10100.37 10059.93 10087.42 3935374
##  5  2317     鴻海 2017-06-02   101.01   101.49   100.53   101.49   38194
##  6  2330   台積電 2017-06-02   201.77   202.26   200.81   202.26   23265
##  7  2412   中華電 2017-06-02   103.13   103.60   102.17   103.13    7341
##  8 Y9999 加權指數 2017-06-02 10117.76 10152.53 10117.06 10152.53 4262071
##  9  2317     鴻海 2017-06-03   101.01   101.49   100.53   101.01    9968
## 10  2330   台積電 2017-06-03   202.26   202.26   201.29   202.26    1535
## # ... with 986 more rows, and 1 more variables: tradeValue &lt;int&gt;
</code></pre><p>接下來我們將以此範例資料，來介紹<code>tidyquant</code>套件的函數用法。</p>
<hr>
<h2 id="計算技術指標寫法示範">計算技術指標寫法示範</h2>
<p>此小節示範如何撰寫技術指標，主要是利用<code>tq_mutate()</code>函數，其引數依序為:</p>
<ol>
<li>data: 資料集。</li>
<li>select: 選擇計算技術指標函數會使用到的資料欄位。</li>
<li>mutate_fun: 選擇要用的技術指標函數(<code>TTR</code>套件)。</li>
<li>技術指標函數之參數設定。</li>
</ol>
<p>透過<code>group_by()</code>函數搭配<code>tq_mutate()</code>函數以及<code>TTR</code>套件的技術指標函數，即可用簡潔的程式碼快速地計算出各支股票的技術指標值。以下為計算5日簡單移動平均線範例：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># 計算簡單移動平均線參數</span>
stockData <span style="color:#f92672">&lt;-</span> stockData <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">arrange</span>(code, date) <span style="color:#f92672">%&gt;%</span>         <span style="color:#75715e"># 資料排序</span>
  <span style="color:#a6e22e">group_by</span>(code) <span style="color:#f92672">%&gt;%</span>              <span style="color:#75715e"># 以股票代碼為群組目標</span>
  <span style="color:#a6e22e">tq_mutate</span>(select <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(close),    <span style="color:#75715e"># 選擇收盤價</span>
            mutate_fun <span style="color:#f92672">=</span> SMA,     <span style="color:#75715e"># 選擇簡單移動平均線</span>
            n <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>) <span style="color:#f92672">%&gt;%</span>            <span style="color:#75715e"># 5日簡單移動平均線參數</span>
  <span style="color:#a6e22e">rename</span>(ma5 <span style="color:#f92672">=</span> SMA)               <span style="color:#75715e"># 重新命名欄位</span>
  
<span style="color:#75715e"># 觀看資料</span>
stockData <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">select</span>(code, date, close, ma5) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">arrange</span>(code, date) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">na.omit</span>()
</code></pre></div><pre><code>## # A tibble: 980 x 4
## # Groups:   code [4]
##     code       date  close     ma5
##    &lt;chr&gt;     &lt;date&gt;  &lt;dbl&gt;   &lt;dbl&gt;
##  1  2317 2017-06-06 101.01 101.106
##  2  2317 2017-06-07 101.01 101.202
##  3  2317 2017-06-08 101.01 101.106
##  4  2317 2017-06-09 101.01 101.106
##  5  2317 2017-06-12  98.13 100.434
##  6  2317 2017-06-13  98.13  99.858
##  7  2317 2017-06-14  98.13  99.282
##  8  2317 2017-06-15  98.61  98.802
##  9  2317 2017-06-16 101.01  98.802
## 10  2317 2017-06-19 105.34 100.244
## # ... with 970 more rows
</code></pre><p>如果要再算10日及20日簡單移動平均線，則繼續向後新增<code>tq_mutate()</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">stockData <span style="color:#f92672">&lt;-</span> stockData <span style="color:#f92672">%&gt;%</span>
  
  <span style="color:#75715e"># 計算10日簡單移動平均線參數</span>
  <span style="color:#a6e22e">tq_mutate</span>(select <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(close),
            mutate_fun <span style="color:#f92672">=</span> SMA,
            n <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">rename</span>(ma10 <span style="color:#f92672">=</span> SMA) <span style="color:#f92672">%&gt;%</span>
  
  <span style="color:#75715e"># 計算20日簡單移動平均線參數</span>
  <span style="color:#a6e22e">tq_mutate</span>(select <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(close),
            mutate_fun <span style="color:#f92672">=</span> SMA,
            n <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">rename</span>(ma20 <span style="color:#f92672">=</span> SMA)

<span style="color:#75715e"># 觀看資料</span>
stockData <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">select</span>(code, date, close, ma10<span style="color:#f92672">:</span>ma20) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">arrange</span>(code, date) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">na.omit</span>()
</code></pre></div><pre><code>## # A tibble: 920 x 5
## # Groups:   code [4]
##     code       date  close    ma10     ma20
##    &lt;chr&gt;     &lt;date&gt;  &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
##  1  2317 2017-06-27 116.89 107.074 103.7780
##  2  2317 2017-06-28 113.52 108.613 104.4275
##  3  2317 2017-06-29 114.48 110.200 105.0770
##  4  2317 2017-06-30 112.56 111.355 105.6545
##  5  2317 2017-07-03 112.08 112.029 106.1840
##  6  2317 2017-07-04 108.71 111.885 106.5690
##  7  2317 2017-07-05 111.59 112.173 107.0980
##  8  2317 2017-07-06 111.11 112.461 107.6030
##  9  2317 2017-07-07 110.15 112.653 108.0600
## 10  2317 2017-07-10 111.11 112.220 108.7090
## # ... with 910 more rows
</code></pre><p>若要計算隨機指標，寫法為:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">stockData <span style="color:#f92672">&lt;-</span> stockData <span style="color:#f92672">%&gt;%</span>
  
  <span style="color:#75715e"># 計算隨機指標</span>
  <span style="color:#a6e22e">tq_mutate</span>(select <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(high, low, close),   
            mutate_fun <span style="color:#f92672">=</span> stoch, 
            nFastK <span style="color:#f92672">=</span> <span style="color:#ae81ff">14</span>, 
            nFastD <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, 
            nSlowD <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>)

<span style="color:#75715e"># 觀看資料</span>
stockData <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">select</span>(code, date, fastK<span style="color:#f92672">:</span>stoch) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">arrange</span>(code, date) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">na.omit</span>()
</code></pre></div><pre><code>## # A tibble: 928 x 5
## # Groups:   code [4]
##     code       date     fastK     fastD     stoch
##    &lt;chr&gt;     &lt;date&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
##  1  2317 2017-06-23 0.8218263 0.8337045 0.8790184
##  2  2317 2017-06-26 0.9496104 0.8644210 0.8597810
##  3  2317 2017-06-27 0.9536008 0.9083458 0.8688238
##  4  2317 2017-06-28 0.7907202 0.8979771 0.8902480
##  5  2317 2017-06-29 0.8371194 0.8604801 0.8889343
##  6  2317 2017-06-30 0.7443209 0.7907202 0.8497258
##  7  2317 2017-07-03 0.7211213 0.7675205 0.8062403
##  8  2317 2017-07-04 0.5365112 0.6673178 0.7418528
##  9  2317 2017-07-05 0.6746362 0.6440895 0.6929760
## 10  2317 2017-07-06 0.5755668 0.5955714 0.6356596
## # ... with 918 more rows
</code></pre><p><code>tq_mutate()</code>函數內的<code>nFastK</code>、<code>nFastD</code>及<code>nSlowD</code>引數即為原<code>TTR</code>套件<code>stoch()</code>的引數。從上面的資料表可以發現，透過<code>tq_mutate()</code>函數，可將<code>TTR</code>套件<code>stoch()</code>函數跑出的3個欄位結果(<code>fastK</code>、<code>fastD</code>及<code>stoch</code>)全部新增在<code>stockData</code>資料表內。若沒有<code>tq_mutate()</code>這個函數，用<code>mutate()</code>函數計算隨機指標會是件很麻煩的事情。</p>
<p>若要計算MACD指標，寫法為:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">stockData <span style="color:#f92672">&lt;-</span> stockData <span style="color:#f92672">%&gt;%</span>

  <span style="color:#75715e"># 計算MACD指標</span>
  <span style="color:#a6e22e">tq_mutate</span>(select <span style="color:#f92672">=</span> close,                
            mutate_fun <span style="color:#f92672">=</span> MACD, 
            nFast <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>, 
            nSlow <span style="color:#f92672">=</span> <span style="color:#ae81ff">26</span>, 
            nSig  <span style="color:#f92672">=</span> <span style="color:#ae81ff">9</span>)               

<span style="color:#75715e"># 觀看資料</span>
stockData <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">select</span>(code, date, macd<span style="color:#f92672">:</span>signal) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">arrange</span>(code, date) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">na.omit</span>()
</code></pre></div><pre><code>## # A tibble: 864 x 4
## # Groups:   code [4]
##     code       date     macd   signal
##    &lt;chr&gt;     &lt;date&gt;    &lt;dbl&gt;    &lt;dbl&gt;
##  1  2317 2017-07-17 3.399607 3.703507
##  2  2317 2017-07-18 3.414634 3.645732
##  3  2317 2017-07-19 3.385078 3.593601
##  4  2317 2017-07-20 3.286600 3.532201
##  5  2317 2017-07-21 3.066426 3.439046
##  6  2317 2017-07-24 2.928384 3.336914
##  7  2317 2017-07-25 2.855695 3.240670
##  8  2317 2017-07-26 2.661369 3.124810
##  9  2317 2017-07-27 2.617056 3.023259
## 10  2317 2017-07-28 2.551553 2.928918
## # ... with 854 more rows
</code></pre><p>和隨機指標寫法架構一樣，<code>tq_mutate()</code>函數內的<code>nFast</code>、<code>nSlow</code>及<code>nSig</code>引數即為原<code>TTR</code>套件<code>MACD()</code>的引數。</p>
<hr>
<h2 id="計算績效指標寫法示範">計算績效指標寫法示範</h2>
<p>有時我們會想要計算每個股票的績效指標，進行一些財務分析(例如建構投資組合及股票評價等)。<code>tidyquant</code>套件完美地整合<code>PerformanceAnalytics</code>套件，讓我們很方便地去計算績效指標。在計算績效指標時，我們需先將各檔股票股價資料整理成報酬率資料，並額外整理出臺灣加權指數報酬率做為市場報酬率，資料整理範例如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># 計算各資產報酬率</span>
stockRet <span style="color:#f92672">&lt;-</span> stockData <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">select</span>(code<span style="color:#f92672">:</span>date, close) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">group_by</span>(code) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">arrange</span>(code, date) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">mutate</span>(ret <span style="color:#f92672">=</span> close<span style="color:#f92672">/</span><span style="color:#a6e22e">lag</span>(close)<span style="color:#ae81ff">-1</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">ungroup</span>() <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">na.omit</span>()

<span style="color:#75715e"># 整理市場報酬率</span>
mktRet <span style="color:#f92672">&lt;-</span> stockRet <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">filter</span>(code <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Y9999&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">select</span>(date, ret) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">rename</span>(mktRet <span style="color:#f92672">=</span> ret)
  
<span style="color:#75715e"># 整理各資產報酬率並且併入各交易日對應的市場報酬率</span>
stockRet <span style="color:#f92672">&lt;-</span> stockRet <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">select</span>(code<span style="color:#f92672">:</span>date, ret) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">filter</span>(code <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;Y9999&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">left_join</span>(mktRet, by <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;date&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;date&#34;</span>))
</code></pre></div><p>整理完後的資料，每個資產在每個交易日都有日報酬率和當日對應的市場報酬率，如下所示：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">stockRet
</code></pre></div><pre><code>## # A tibble: 744 x 5
##     code  name       date          ret        mktRet
##    &lt;chr&gt; &lt;chr&gt;     &lt;date&gt;        &lt;dbl&gt;         &lt;dbl&gt;
##  1  2317  鴻海 2017-06-02  0.009549388  0.0064545741
##  2  2317  鴻海 2017-06-03 -0.004729530  0.0005535566
##  3  2317  鴻海 2017-06-05  0.004752005  0.0067620581
##  4  2317  鴻海 2017-06-06 -0.004729530 -0.0020201744
##  5  2317  鴻海 2017-06-07  0.000000000  0.0003733032
##  6  2317  鴻海 2017-06-08  0.000000000  0.0015465245
##  7  2317  鴻海 2017-06-09  0.000000000 -0.0025553063
##  8  2317  鴻海 2017-06-12 -0.028512029 -0.0087934390
##  9  2317  鴻海 2017-06-13  0.000000000  0.0017992158
## 10  2317  鴻海 2017-06-14  0.000000000 -0.0054985363
## # ... with 734 more rows
</code></pre><p>接下來示範如何計算績效指標，主要是透過<code>tq_performance()</code>函數，其引數依序為:</p>
<ol>
<li>data: 資料集。</li>
<li>Ra: 資產報酬率。</li>
<li>Rb: 市場基準報酬率。</li>
<li>performance_fun: 績效指標函數(<code>PerformanceAnalytics</code>套件)。</li>
<li>績效指標函數之參數設定。</li>
</ol>
<p>以計算常用的夏普比率為例，此處假設無風險年利率為1%，程式寫法如下。需注意的地方是，計算夏普比率時不需要用到市場報酬率，因此Rb的參數我們給NULL值。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">sharpeRatio <span style="color:#f92672">&lt;-</span> stockRet <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">group_by</span>(code) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">tq_performance</span>(Ra <span style="color:#f92672">=</span> ret,
                 Rb <span style="color:#f92672">=</span> <span style="color:#66d9ef">NULL</span>,
                 performance_fun <span style="color:#f92672">=</span> SharpeRatio,
                 Rf <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span><span style="color:#f92672">/</span><span style="color:#ae81ff">252</span>)

<span style="color:#75715e"># 觀看資料</span>
sharpeRatio
</code></pre></div><pre><code>## # A tibble: 3 x 4
## # Groups:   code [3]
##    code `ESSharpe(Rf=0%,p=95%)` `StdDevSharpe(Rf=0%,p=95%)`
##   &lt;chr&gt;                   &lt;dbl&gt;                       &lt;dbl&gt;
## 1  2317             -0.02012416                 -0.03741787
## 2  2330              0.01323757                  0.03772705
## 3  2412              0.01668980                  0.03367462
## # ... with 1 more variables: `VaRSharpe(Rf=0%,p=95%)` &lt;dbl&gt;
</code></pre><p>和<code>tq_mutate()</code>函數架構一樣，<code>tq_performance()</code>函數內的<code>Rf</code>引數為原<code>PerformanceAnalytics</code>套件<code>SharpeRatio()</code>的引數。</p>
<p>若要跑資本資產定價模型(CAPM)，則寫法為:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">capmTable <span style="color:#f92672">&lt;-</span> stockRet <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">group_by</span>(code) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">tq_performance</span>(Ra <span style="color:#f92672">=</span> ret, 
                 Rb <span style="color:#f92672">=</span> mktRet, 
                 performance_fun <span style="color:#f92672">=</span> table.CAPM,
                 Rf <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span><span style="color:#f92672">/</span><span style="color:#ae81ff">252</span>)

<span style="color:#75715e"># 觀看資料</span>
capmTable
</code></pre></div><pre><code>## # A tibble: 3 x 13
## # Groups:   code [3]
##    code ActivePremium  Alpha AnnualizedAlpha   Beta `Beta-` `Beta+`
##   &lt;chr&gt;         &lt;dbl&gt;  &lt;dbl&gt;           &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
## 1  2317       -0.2291 -1e-03         -0.2167 1.3815  1.1093  1.5340
## 2  2330        0.0408  1e-04          0.0161 1.5010  1.3020  1.6403
## 3  2412       -0.0215  1e-04          0.0248 0.3600  0.3675  0.4613
## # ... with 6 more variables: Correlation &lt;dbl&gt;,
## #   `Correlationp-value` &lt;dbl&gt;, InformationRatio &lt;dbl&gt;, `R-squared` &lt;dbl&gt;,
## #   TrackingError &lt;dbl&gt;, TreynorRatio &lt;dbl&gt;
</code></pre><hr>
<h2 id="資料頻率轉換">資料頻率轉換</h2>
<p>上述計算績效指標時皆採用日頻資料，但一般常見的作法是用月頻資料來計算績效指標。在<code>tidyquant</code>套件中，使用<code>tq_transmute()</code>函數搭配原本<code>quantmod</code>套件內的<code>periodReturn()</code>函數，可以很輕易地對資料做頻率轉換。<code>tq_transmute()</code>的引數依序為:</p>
<ol>
<li>data: 資料集。</li>
<li>select: 選擇資料欄位。</li>
<li>mutate_fun: 套件函數。</li>
<li>col_rename: 新增的欄位名稱。</li>
<li>套件函數之參數設定。</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># 轉換成月頻資料</span>
stockMonthRet <span style="color:#f92672">&lt;-</span> stockData <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">group_by</span>(code) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">tq_transmute</span>(select <span style="color:#f92672">=</span> close,
               mutate_fun <span style="color:#f92672">=</span> periodReturn,
               col_rename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;monthRet&#34;</span>,
               period <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;monthly&#34;</span>)

<span style="color:#75715e"># 觀看資料</span>
stockMonthRet
</code></pre></div><pre><code>## # A tibble: 48 x 3
## # Groups:   code [4]
##     code       date     monthRet
##    &lt;chr&gt;     &lt;date&gt;        &lt;dbl&gt;
##  1  2317 2017-06-30  0.119665771
##  2  2317 2017-07-31  0.043887704
##  3  2317 2017-08-31  0.000000000
##  4  2317 2017-09-30 -0.089361702
##  5  2317 2017-10-31  0.046728972
##  6  2317 2017-11-30 -0.107142857
##  7  2317 2017-12-29 -0.048000000
##  8  2317 2018-01-31 -0.031512605
##  9  2317 2018-02-27 -0.044468547
## 10  2317 2018-03-31  0.004540295
## # ... with 38 more rows
</code></pre><p>如果想要計算季頻或年頻，只要在<code>period</code>參數改成<code>quarterly</code>或<code>yearly</code>即可：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># 轉換成季頻資料</span>
stockQuarterRet <span style="color:#f92672">&lt;-</span> stockData <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">group_by</span>(code) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">tq_transmute</span>(select <span style="color:#f92672">=</span> close,
               mutate_fun <span style="color:#f92672">=</span> periodReturn,
               col_rename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;monthRet&#34;</span>,
               period <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;quarterly&#34;</span>)

<span style="color:#75715e"># 觀看資料</span>
stockQuarterRet
</code></pre></div><pre><code>## # A tibble: 20 x 3
## # Groups:   code [4]
##     code       date     monthRet
##    &lt;chr&gt;     &lt;date&gt;        &lt;dbl&gt;
##  1  2317 2017-06-30  0.119665771
##  2  2317 2017-09-30 -0.049395878
##  3  2317 2017-12-29 -0.110280374
##  4  2317 2018-03-31 -0.070378151
##  5  2317 2018-05-31 -0.031638418
##  6  2330 2017-06-30  0.040834665
##  7  2330 2017-09-30  0.038369305
##  8  2330 2017-12-29  0.060046189
##  9  2330 2018-03-31  0.078431373
## 10  2330 2018-05-31 -0.094949495
## 11  2412 2017-06-30  0.000000000
## 12  2412 2017-09-30  0.013284204
## 13  2412 2017-12-29  0.014354067
## 14  2412 2018-03-31  0.066037736
## 15  2412 2018-05-31 -0.035398230
## 16 Y9999 2017-06-30  0.030498383
## 17 Y9999 2017-09-30 -0.001070700
## 18 Y9999 2017-12-29  0.024934659
## 19 Y9999 2018-03-31  0.025992074
## 20 Y9999 2018-05-31 -0.004078029
</code></pre><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># 轉換成年頻資料</span>
stockYearRet <span style="color:#f92672">&lt;-</span> stockData <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">group_by</span>(code) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">tq_transmute</span>(select <span style="color:#f92672">=</span> close,
               mutate_fun <span style="color:#f92672">=</span> periodReturn,
               col_rename <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;monthRet&#34;</span>,
               period <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;yearly&#34;</span>)

<span style="color:#75715e"># 觀看資料</span>
stockYearRet
</code></pre></div><pre><code>## # A tibble: 8 x 3
## # Groups:   code [4]
##    code       date    monthRet
##   &lt;chr&gt;     &lt;date&gt;       &lt;dbl&gt;
## 1  2317 2017-12-29 -0.05301900
## 2  2317 2018-05-31 -0.09978992
## 3  2330 2017-12-29  0.14566693
## 4  2330 2018-05-31 -0.02396514
## 5  2412 2017-12-29  0.02782895
## 6  2412 2018-05-31  0.02830189
## 7 Y9999 2017-12-29  0.05506264
## 8 Y9999 2018-05-31  0.02180805
</code></pre><hr>
<h2 id="繪製圖形">繪製圖形</h2>
<p><code>tidyquant</code>除了將財務領域套件與<code>dplyr</code>套件做結合外，與<code>ggplot2</code>繪圖套件也整合得相當好，接下來將會展現幾個範例。</p>
<ul>
<li>繪製股價日頻走勢圖</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">stockData <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> date, y <span style="color:#f92672">=</span> close, color <span style="color:#f92672">=</span> code)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_line</span>(size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span>
    <span style="color:#a6e22e">labs</span>(title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Daily Stock Prices&#34;</span>,
         x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>, y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Close Prices&#34;</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>) <span style="color:#f92672">+</span>
    <span style="color:#a6e22e">facet_wrap</span>(<span style="color:#f92672">~</span> code, ncol <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, scales <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;free_y&#34;</span>) <span style="color:#f92672">+</span>
    <span style="color:#a6e22e">scale_y_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span>dollar) <span style="color:#f92672">+</span>
    <span style="color:#a6e22e">theme_tq</span>() <span style="color:#f92672">+</span> 
    <span style="color:#a6e22e">scale_color_tq</span>()
</code></pre></div><p><!-- raw HTML omitted --></p>
<ul>
<li>繪製技術分析圖形(以台積電為例)</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">stockData <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">filter</span>(code <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;2330&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> date, y <span style="color:#f92672">=</span> close)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_candlestick</span>(<span style="color:#a6e22e">aes</span>(open <span style="color:#f92672">=</span> open, high <span style="color:#f92672">=</span> high, low <span style="color:#f92672">=</span> low, close <span style="color:#f92672">=</span> close),
                   color_up <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;firebrick3&#34;</span>, color_down <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;chartreuse3&#34;</span>, 
                   fill_up  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;firebrick3&#34;</span>, fill_down  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;chartreuse3&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2330 Candlestick Chart&#34;</span>, y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Closing Price&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">theme_tq</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_x_date</span>(expand <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>))
</code></pre></div><p><!-- raw HTML omitted --></p>
<ul>
<li>繪製技術分析圖形(以台積電為例)及5日、10日及20日均線</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">stockData <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">filter</span>(code <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;2330&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> date, y <span style="color:#f92672">=</span> close)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_candlestick</span>(<span style="color:#a6e22e">aes</span>(open <span style="color:#f92672">=</span> open, high <span style="color:#f92672">=</span> high, low <span style="color:#f92672">=</span> low, close <span style="color:#f92672">=</span> close),
                   color_up <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;firebrick3&#34;</span>, color_down <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;chartreuse3&#34;</span>, 
                   fill_up  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;firebrick3&#34;</span>, fill_down  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;chartreuse3&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_ma</span>(ma_fun <span style="color:#f92672">=</span> SMA, n <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>, linetype <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>,size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_ma</span>(ma_fun <span style="color:#f92672">=</span> SMA, n <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;orange&#34;</span>, linetype <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">geom_ma</span>(ma_fun <span style="color:#f92672">=</span> SMA, n <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;green&#34;</span>, linetype <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2330 Candlestick Chart&#34;</span>, y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Closing Price&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">theme_tq</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_x_date</span>(expand <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>))
</code></pre></div><p><!-- raw HTML omitted --></p>
<ul>
<li>繪製技術分析圖形(以台積電為例)及布林通道</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">stockData <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">filter</span>(code <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;2330&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">ggplot</span>(<span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> date, y <span style="color:#f92672">=</span> close, open <span style="color:#f92672">=</span> open, high <span style="color:#f92672">=</span> high, low <span style="color:#f92672">=</span> low, close <span style="color:#f92672">=</span> close)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_candlestick</span>(color_up <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;firebrick3&#34;</span>, color_down <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;chartreuse3&#34;</span>, 
                   fill_up  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;firebrick3&#34;</span>, fill_down  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;chartreuse3&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_bbands</span>(ma_fun <span style="color:#f92672">=</span> SMA, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, n <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>, 
              linetype <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.2</span>,
              fill <span style="color:#f92672">=</span> <span style="color:#a6e22e">palette_light</span>()[[1]],
              color_bands <span style="color:#f92672">=</span> <span style="color:#a6e22e">palette_light</span>()[[1]],
              color_ma <span style="color:#f92672">=</span> <span style="color:#a6e22e">palette_light</span>()[[2]]) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;2330 Candlestick Chart&#34;</span>, y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Closing Price&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">theme_tq</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_x_date</span>(expand <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>))
</code></pre></div><p><!-- raw HTML omitted --></p>
<hr>
<h2 id="結語">結語</h2>
<p>從上述的範例中，可以看到<code>tidyquant</code>套件很棒地將財務套件與<code>tidyverse</code>套件完美地結合。不用再寫太多複雜的程式和迴圈，繞來繞去地去計算每支股票的技術指標和績效指標。這個套件的整合，對於用R語言做財務分析的使用者來說真是一大福音！本篇文章僅擷取<code>tidyquant</code>套件最重要的部分，但原作者撰寫的說明文章還有更多細節及應用，對於此套件有興趣的讀者，建議可去點閱來看。</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="/post/use-eval-function-compute-ma/">
                  <span class="button__icon">←</span>
                  <span class="button__text">利用eval函數計算多個移動平均線指標</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="/post/parallel-introduction/">
                  <span class="button__text">R的平行運算</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    
    <hr>
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "suyenting" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Hello Friend, I&#39;m Yestin!</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span
          >© 2022 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
        <span
          >Theme created by
          <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span
        >
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
